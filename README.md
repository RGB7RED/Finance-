# Мои финансы (Telegram Mini App)

Приложение для ежедневного учёта денег и планирования стратегии: баланс, долги, цели, отчёты. Работает как Telegram Mini App. Данные хранятся в Supabase. Деплой фронта на Vercel, backend на Railway.

---

## 1) Цель продукта

### Зачем
Дать пользователю простой и быстрый способ:
- вести ежедневный учёт денег (счета, долги, доходы/расходы),
- получать корректный финансовый отчёт (через сверку двух таблиц),
- планировать цели и получать стратегические рекомендации,
- минимизировать ручной ввод через быстрые операции, импорт и режим обучения.

### Что считается успешным результатом (Definition of Done / Success)
MVP считается успешным, если:
1) Пользователь может вести учёт **30 дней подряд**:
   - ежедневно добавлять операции (доход/расход/перевод),
   - видеть баланс/остаток/долги,
   - сверять “итог дня” (верхний/нижний), устранять расхождения,
   - просматривать отчёты по периодам.
2) **Business-импорт** работает минимум для **1–2 шаблонов выписок** (например: Тинькофф Бизнес / Сбер Бизнес / Альфа Бизнес):
   - загрузка XLSX (и CSV как опция),
   - анализ + preview/маппинг,
   - подтверждение импорта,
   - обработка “сомнительных” операций (низкая уверенность).
3) Приложение корректно работает при **пустых данных и первом запуске** без ошибок.
4) Реализованы **цели** (накопление, лимит категорий, погасить долг, подушка) и **стратегические подсказки**.
5) Реализован режим обучения на фидбэке пользователя:
   - правила “описание/контрагент → категория/счёт”,
   - экран управления правилами,
   - улучшение предложений со временем.
6) UI адаптирован под мобильный формат и ощущается как приложение (PWA-like).
7) Допуск расхождения в сверке: **до 1 рубля** (копейки игнорируем).

---

## 2) Платформа и стек

### Frontend
- Next.js (Vercel)
- Telegram WebApp SDK
- PWA-like mobile UI (карточки + формы)
- Экран “быстро добавить” и экран операции (1 экран)

### Backend (BFF)
- FastAPI (Railway)
- Telegram initData verification
- JWT session
- API для фронта
- Интеграция с Supabase (DB + Storage)

### DB/Storage
- Supabase Postgres
- Supabase Storage для импортируемых файлов

---

## 3) Режимы: личный и бизнес

У каждого пользователя есть 2 режима:
- **Personal**: ручной ввод + опциональный импорт
- **Business**: мастер импорта расчётного счёта (выписка) → AI draft → preview/confirm

В MVP: **1 personal и 1 business бюджет** на пользователя.

---

## 4) Модель учета: 2 таблицы + сверка

В приложении фиксируется два “вида” данных.

### Таблица 1: Состояние (остатки/долги/баланс)
Логика:
- **Остаток = Наличка + Безнал**
- **Долги = Кредитки/рассрочки + Долги людям**
- **Баланс = Остаток − Долги**
- **Итог верхний за день = Баланс(сегодня) − Баланс(вчера)**

Особенности:
- учет разбит по **счетам** (наличка + банковские счета/карты)
- кредитки/рассрочки — одной суммой
- долги людям — детально (карточки долгов)

### Таблица 2: Операции (доходы/расходы)
Логика:
- **Итог нижний за день = Доходы(день) − Расходы(день)**

Операции:
- доход
- расход
- перевод между своими счетами (**transfer**; не влияет на доход/расход)

### Сверка
Сверяем только итоги:
- `Δ = Итог_верхний_за_день − Итог_нижний_за_день`
- если `|Δ| <= 1` → отчёт корректен
- если `|Δ| > 1` → показываем Δ и предлагаем исправление:
  - по умолчанию: **создать корректировку по счету** (“уменьшить/увеличить счет X на Δ”)
  - разрешаем распределение Δ по нескольким счетам
  - предлагаем наиболее вероятные счета по истории пользователя
  - карточка “Закрой день” на Dashboard, если день не сходится

---

## 5) Принцип “авто из операций + ручная корректировка”

Источник истины:
- **transactions** — первичные движения
- **daily_state** — агрегированное состояние дня

Остатки на день считаются как:
- остаток вчера
+ движения сегодня (по операциям с account_id)
+ ручные корректировки (adjustments)

Для ручной корректировки используется сущность `account_adjustments`.

---

## 6) Импорт (особенно Business)

### Общий флоу импорта
1) Загрузка файла (XLSX приоритет, CSV опционально)
2) Парсинг и анализ
3) AI draft:
   - распознанные операции,
   - предложенные категории,
   - предложенные счета,
   - confidence по операциям
4) Preview + маппинг:
   - пользователь видит, куда что будет внесено
5) Подтверждение:
   - данные фиксируются (создаются операции)
6) Экран “Проверить сомнительные”:
   - список низкоуверенных операций для подтверждения/исправления
7) Обработка дублей:
   - кнопка “Слить дубликаты” при повторном импорте

### Режим “черновик без сохранения”
Пользователь может сделать импорт “посмотреть анализ” без сохранения в базу.

### Профили банков
Сохраняем профиль маппинга под:
- Тинькофф Бизнес
- Сбер Бизнес
- Альфа Бизнес
(можно расширять)

---

## 7) Режим обучения (персонализация)

Обучение основано на подтверждениях/исправлениях пользователя:
- “описание/контрагент → категория”
- “описание/контрагент → счет”
- “подтверждение исправления Δ → предпочтительный счет”

Функции:
- авто-предложение категории/счёта
- шаблоны быстрых операций (1 тап)
- экран “Мои правила” (вкл/выкл/удалить)
- фидбэк события сохраняются и улучшают уверенность

---

## 8) Цели и стратегические подсказки

Цели MVP:
- накопление суммы к дате
- лимит расходов по категории
- погасить долг к дате
- подушка безопасности

Подсказки (уровень B — стратегические):
- прогноз “успеешь/не успеешь”
- сценарии “что если” (сократить категорию на X%)
- предупреждения о риске цели/перерасходе (внутри приложения)

---

## 9) UX / Экраны MVP

1) Dashboard
- баланс/остаток/долги
- статус сверки за сегодня (сходится/Δ)
- кнопка “+ Быстро”

2) День
- карточка состояния (счета/долги/баланс/верхний итог)
- карточка операций (доходы/расходы/категории/нижний итог)
- блок “Расхождение Δ” + варианты исправления
- кнопка “Закрыть день”

3) Операция (1 экран)
- тип: доход/расход/перевод
- сумма
- категория
- счет (опционально)
- описание
- теги (пользовательские)
- удалить операцию

4) Счета
- список счетов (наличка, карты/банки)
- настройки

5) Долги людям
- список долгов (карточки: кому/остаток/дата)

6) Аналитика
- расходы по категориям за период
- динамика баланса
- доходы/расходы по дням
- долги + простой график/план

7) Цели
- цели + прогноз + подсказки

8) Импорт
- загрузка → preview → подтверждение → сомнительные → готово

---

## 10) Нефункциональные требования

- Никаких копеек, округление до рубля.
- Должно работать при пустых данных без ошибок.
- Logout обязателен.
- Описания операций разрешены к хранению.

### Логирование (минимально необходимое)
Логируем только тех. события (без сумм/описаний):
- auth_ok/auth_fail
- import_started/import_confirmed/import_error
- calc_mismatch_detected
- api_error
(в логах только IDs)

---

## 11) Данные (сущности / ER-скелет)

Основные таблицы:
- users
- budgets (personal/business)
- accounts
- categories (с parent_id)
- transactions (income/expense/transfer)
- daily_state (агрегаты по дню)
- account_adjustments (ручные корректировки)
- debts_people (долги людям)
- goals
- imports (draft/preview/confirm)
- user_rules_categories
- user_rules_accounts
- user_feedback_events
- bank_profiles (шаблоны маппинга банков)

---

## 12) API (черновой список)

Auth:
- POST /auth/telegram

Budgets/Accounts:
- GET/POST /budgets
- GET/POST/PATCH/DELETE /accounts

Categories/Tags:
- GET/POST/PATCH/DELETE /categories
- (теги как user-defined список или поле в transactions)

Transactions:
- GET/POST/PATCH/DELETE /transactions
- POST /transactions/transfer

Daily:
- GET /daily?date=YYYY-MM-DD
- GET /daily/month?month=YYYY-MM
- POST /adjustments

Debts:
- GET/POST/PATCH/DELETE /debts/people

Goals:
- GET/POST/PATCH/DELETE /goals
- GET /goals/insights

Import:
- POST /imports/upload
- GET /imports/{id}/draft
- POST /imports/{id}/confirm
- POST /imports/{id}/discard
- GET /imports/{id}/review-low-confidence
- POST /imports/{id}/merge-duplicates

Learning:
- GET/POST/PATCH/DELETE /rules/categories
- GET/POST/PATCH/DELETE /rules/accounts
- POST /feedback

---

## 13) План работ (для Codex)

Этап 1 — README + каркас
- добавить этот README
- создать структуру репозитория
- настроить деплой Vercel (frontend) и Railway (backend)

Этап 2 — Auth + база
- Telegram initData verification
- JWT
- Supabase schema + migrations
- базовые CRUD

Этап 3 — Учет и сверка
- transactions + transfer
- daily_state auto + adjustments
- сверка Δ + “закрыть день”

Этап 4 — Импорт
- upload → parse → draft → preview → confirm
- low confidence review
- merge duplicates
- bank profiles

Этап 5 — Обучение
- rules + feedback
- “Мои правила”
- автоподстановки + шаблоны быстрых операций

Этап 6 — Аналитика и цели
- отчёты
- цели + прогноз + “what if” сценарии

---

## 14) Roadmap (после MVP)
- Email login + расширение аутентификации
- Подписки и плановые платежи
- Мультивалюта
- Расширенные долги (платежи/график/проценты)
- Интеграции банков через API (если возможно)

## Repository Structure

```
.
├── backend/
├── docs/
├── frontend/
├── infra/
└── supabase/
```

## Local Development

Frontend:

```bash
cd frontend
npm install
npm run dev
```

Backend:

```bash
cd backend
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
uvicorn app.main:app --reload
```

## Deploy Overview

- Vercel: frontend
- Railway: backend
- Supabase: DB + Storage

## Environment Variables

See [docs/ENV_VARS.md](docs/ENV_VARS.md).
